// controllers/notificationController.js
const { registerDeviceToken , getUserTokens} = require('../services/NotificationService');
const { sendPushNotification } = require('../Util/Expo');

exports.saveDeviceToken = async (req, res) => {
  console.log('Received request:', req.body);

  const { agent_id, token } = req.body;
  
  if (!agent_id || !token) {
    console.log('Missing fields:', { agent_id, token });
    return res.status(400).json({ error: "agent_id and token are required" });
  }

  try {
    const savedToken = await registerDeviceToken(agent_id, token);
    console.log('Saved token:', savedToken);
    res.status(200).json({ message: "Token registered successfully" });
  } catch (error) {
    console.error("Controller Error:", error.message || error);
    res.status(500).json({ error: "Failed to save token" });
  }
};


exports.sendNotification = async (req, res) => {
  const {agent_id, title, body, data } = req.body;
  try {
    const tokens = await getUserTokens(agent_id);
    const tokenList = tokens.map((t) => t.token);

    if (tokenList.length === 0) {
      return res.status(400).json({ message: 'No device tokens found for user' });
    }

    await sendPushNotification(tokenList, title, body, data);
    res.status(200).json({ message: 'Notification sent successfully' });
  } catch (error) {
    res.status(500).json({ error: 'Failed to send notification' });
  }
};
